<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show Control - Cue Sheet Profesional</title>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .cue-dot { transition: all 0.2s ease; shadow: 0 0 10px rgba(0,0,0,0.5); }
        .cue-dot:hover { transform: scale(1.8); z-index: 50; cursor: pointer; box-shadow: 0 0 15px white; }
        .active-text { text-shadow: 0 0 20px rgba(192, 38, 211, 0.5); }
        #loginOverlay { transition: opacity 0.5s ease; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <div id="loginOverlay" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-4">
        <div class="glass p-8 rounded-2xl max-w-sm w-full text-center">
            <h1 class="text-xl font-light tracking-widest mb-6">ACCESO DE PRODUCCIÓN</h1>
            <input type="password" id="passInput" placeholder="Contraseña" class="w-full bg-slate-900 border border-slate-700 p-3 rounded-lg mb-4 text-center outline-none focus:border-fuchsia-500 transition-colors">
            <button onclick="checkPass()" class="w-full bg-fuchsia-600 hover:bg-fuchsia-500 py-3 rounded-lg font-bold transition-all">ENTRAR</button>
            <p id="errorMsg" class="text-red-500 text-sm mt-4 hidden">Contraseña incorrecta</p>
        </div>
    </div>

    <div class="glass h-1/3 flex flex-col justify-center items-center p-6 text-center relative z-20 shadow-2xl">
        <div class="absolute top-4 right-4">
            <select id="filterSelect" class="bg-slate-800 text-white text-xs p-2 rounded-full border border-slate-600 outline-none cursor-pointer hover:bg-slate-700 transition-colors">
                <option value="ALL">TODOS LOS DEPARTAMENTOS</option>
            </select>
        </div>
        <h2 class="text-slate-500 tracking-[0.3em] text-[10px] uppercase mb-4">Cue Actual en Escena</h2>
        <div id="activeCueDisplay" class="active-text text-4xl md:text-6xl font-black text-white transition-all duration-500 uppercase italic">
            SISTEMA LISTO
        </div>
        <div id="nextCueDisplay" class="text-slate-500 text-xs mt-6 font-mono tracking-widest uppercase">
            Siguiente: --:--
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-6 space-y-8 custom-scroll">
        
        <div class="glass rounded-2xl p-6 border-t border-blue-500/30 shadow-inner">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[10px] text-blue-400 font-black tracking-tighter uppercase">Master Audio Timeline</h3>
                <span id="timeDisplay" class="font-mono text-xl text-blue-400">00:00</span>
            </div>
            <div id="waveform" class="cursor-pointer"></div>
            <div class="flex justify-center mt-6">
                <button id="playBtn" class="group flex items-center justify-center w-14 h-14 bg-white rounded-full hover:scale-110 transition-transform shadow-xl">
                    <div id="playIcon" class="ml-1 w-0 h-0 border-y-[10px] border-y-transparent border-l-[15px] border-l-slate-900"></div>
                </button>
            </div>
        </div>

        <div id="timelinesContainer" class="space-y-6 pb-20">
            </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const GOOGLE_SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdJ2DaW8hsb4ym2GrsDSYS87oXbT910zIQZuXkA0Cnh_SIqKtw-ssB2-hTowVoeybOO-BYdxUxx5nm/pub?output=csv"; 
        const PASS_CORRECTA = "obra2026"; // <--- CAMBIA TU CONTRASEÑA AQUÍ
        const AUDIO_FILE = "audio.wav"; 

        let cues = [];
        let wavesurfer;
        let duration = 0;
        let uniqueDepts = new Set();

        // SEGURIDAD
        function checkPass() {
            const input = document.getElementById('passInput').value;
            if(input === PASS_CORRECTA) {
                document.getElementById('loginOverlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loginOverlay').remove(), 500);
            } else {
                document.getElementById('errorMsg').classList.remove('hidden');
            }
        }

        document.getElementById('passInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') checkPass();
        });

        // INICIALIZACIÓN
        document.addEventListener('DOMContentLoaded', () => {
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#1e293b',
                progressColor: '#3b82f6',
                cursorColor: '#ffffff',
                height: 100,
                barWidth: 3,
                barRadius: 3,
                responsive: true,
                dragToSeek: true
            });

            wavesurfer.load(AUDIO_FILE);
            
            wavesurfer.on('ready', () => {
                duration = wavesurfer.getDuration();
                loadData();
            });

            wavesurfer.on('audioprocess', () => {
                const time = wavesurfer.getCurrentTime();
                document.getElementById('timeDisplay').innerText = formatTime(time);
                updateCueDisplay(time);
            });

            wavesurfer.on('play', () => { document.getElementById('playIcon').style.border = 'none'; document.getElementById('playIcon').innerHTML = '<div class="flex gap-1"><div class="w-1.5 h-5 bg-slate-900"></div><div class="w-1.5 h-5 bg-slate-900"></div></div>'; });
            wavesurfer.on('pause', () => { document.getElementById('playIcon').innerHTML = ''; document.getElementById('playIcon').style.borderY = '10px transparent'; document.getElementById('playIcon').style.borderLeft = '15px solid #0f172a'; });

            document.getElementById('playBtn').addEventListener('click', () => wavesurfer.playPause());
        });

        function loadData() {
            Papa.parse(GOOGLE_SHEET_CSV, {
                download: true,
                header: true,
                complete: (results) => {
                    cues = results.data
                        .filter(row => row.Tiempo && row.Texto)
                        .map(row => {
                            if(row.Departamento) uniqueDepts.add(row.Departamento.trim());
                            return { ...row, seconds: timeToSeconds(row.Tiempo) };
                        });
                    setupFilters();
                    drawTimelines();
                }
            });
        }

        function drawTimelines() {
            const container = document.getElementById('timelinesContainer');
            container.innerHTML = ''; 

            Array.from(uniqueDepts).sort().forEach(dept => {
                const row = document.createElement('div');
                row.className = "relative h-14 bg-slate-900/40 rounded-xl border border-slate-800 flex items-center group hover:bg-slate-800/40 transition-colors";
                row.innerHTML = `<span class="absolute -top-3 left-4 text-[9px] uppercase font-bold tracking-widest text-slate-500 bg-slate-950 px-2 border border-slate-800 rounded-full">${dept}</span>`;

                const track = document.createElement('div');
                track.className = "w-full h-full relative mx-4";
                
                cues.filter(c => c.Departamento?.trim() === dept).forEach(cue => {
                    const dot = document.createElement('div');
                    dot.className = "cue-dot absolute top-1/2 -translate-y-1/2 w-4 h-4 rounded-full border-2 border-slate-950";
                    dot.style.left = `${(cue.seconds / duration) * 100}%`;
                    dot.style.backgroundColor = cue.Color || '#64748b';
                    
                    dot.onclick = (e) => {
                        e.stopPropagation();
                        wavesurfer.seekTo(cue.seconds / duration);
                    };
                    track.appendChild(dot);
                });

                row.appendChild(track);
                container.appendChild(row);
            });
        }

        function updateCueDisplay(time) {
            const filter = document.getElementById('filterSelect').value;
            const active = cues
                .filter(c => c.seconds <= time && (filter === 'ALL' || c.Departamento?.trim() === filter))
                .sort((a, b) => b.seconds - a.seconds)[0];

            if (active && (time - active.seconds) < 6) { 
                document.getElementById('activeCueDisplay').innerText = active.Texto;
                document.getElementById('activeCueDisplay').style.color = active.Color || '#fff';
            } else {
                document.getElementById('activeCueDisplay').innerText = "---";
                document.getElementById('activeCueDisplay').style.color = "#475569";
            }

            const next = cues
                .filter(c => c.seconds > time && (filter === 'ALL' || c.Departamento?.trim() === filter))
                .sort((a, b) => a.seconds - b.seconds)[0];
            
            document.getElementById('nextCueDisplay').innerText = next ? `Siguiente: ${next.Tiempo} - ${next.Texto}` : "Fin de obra";
        }

        function setupFilters() {
            const select = document.getElementById('filterSelect');
            uniqueDepts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d; opt.innerText = d.toUpperCase();
                select.appendChild(opt);
            });
        }

        function timeToSeconds(str) {
            const p = str.split(':');
            return p.length === 2 ? parseInt(p[0]) * 60 + parseInt(p[1]) : 0;
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }
    </script>
</body>
</html>